---
title: "Solutions to exercises"
author: "Tim Riffe"
date: "2022-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Excercises
I've copy-pasted the exercise questions to have everythnig side-by-side.

1. plot time trends of TFR by country.

```{r, message = FALSE, warning = FALSE}
library(tidyverse)

B <- read_csv("https://raw.githubusercontent.com/timriffe/KOSTAT_Workshop1/master/Data/03_results.csv") %>% 
  filter(version == "session")

Btfr <-
  B %>% 
  group_by(country, year) %>% 
  summarize(TFR = sum(asfr)) 

Btfr %>% 
  ggplot(aes(x=year,y=TFR,color=country))+
  geom_line() +
  theme_minimal()
```


2. Use the time-series trick `lead()` and/or `lag()` to calculate a variable `rt` as:

$$ r(t) = \frac{MAB(t+1) - MAB(t - 1)}{2} $$

NOTE: for this I didn't say whether to use the count or rate MAB. We should use the rate version! Have a look at `Brt` it's all positive numbers. A number like .1 means that MAB would increase a year over the course of a decade.

```{r}
Brt <-
  B %>% 
  group_by(country, year) %>% 
  summarize(mab = (sum((age+.5) * asfr)/sum(asfr)), 
            .groups = "drop") %>% 
  group_by(country) %>% 
  mutate(rt = (lead(mab) - lag(mab)) / 2) %>% 
  filter(!is.na(rt))
```


Here $r(t)$ (in R call the new variable `rt`) approximates the average rate of change in the mean age at childbearing. We can use it to calculate an adjusted form of TFR, `TFR_adj` like so:

$$ TFR_{adj}(t) = \frac{TFR(t)}{1 - r(t)}$$

```{r}
TFRadj <- 
  Brt %>% 
  left_join(Btfr, by = c("country", "year")) %>% 
  mutate(TFRadj = TFR / (1-rt))

```
Let's see whether it makes any difference for anyone in this this small dataset:

```{r}
TFRadj %>% 
  
  # stack in order to *map* in ggplot,
  # will explain Tuesday
  select(country, year, TFR, TFRadj) %>% 
  pivot_longer(c(TFR, TFRadj), names_to = "version", values_to = "TFR") %>% 
  
  ggplot(aes(x = year, y= TFR, color = country, linetype = version)) +
  geom_line() +
  labs(title = "Yes, this adjustment does make quite a difference!")
```


The basic idea is that if fertility is undergoing postponement, then the TFR of today is an underestimate (@bongaarts1998quantum). Without over-thinking the theory, can you calculate a variable called `TFR_adj`, and compare it's (short) time trends with those of TFR in a plot?

3. Choose either rate-weighted MAB or birth-weighted MAB, but redo the calculations in terms of 5-year age groups. Assume that the average age within the interval is simply the midpoint (`Age + 2.5`). Does this change MAB very much?

```{r}
mab1 <-
  B %>% 
  group_by(country, year) %>% 
  summarize(MAB = (sum((age+.5) * asfr)/sum(asfr)), 
            .groups = "drop") %>% 
  mutate(version = "single age mean")

mab5 <-
  B %>% 
  
  # %% is modulo, try it out, neat trick to group ages
  mutate(age5 = age - age %% 5) %>% 
  group_by(country, year, age) %>% 
  summarize(births = sum(births),
            expos = sum(expos),
             .groups = "drop") %>% 
  
  # asfr recalculated after grouping
  mutate(asfr = births / expos) %>% 
  group_by(country, year) %>% 
  
  # same weighted avg, different midpoint, 2.5
  summarize(MAB = (sum((age + 2.5) * asfr)/sum(asfr)), 
            .groups = "drop")%>% 
  mutate(version = "5-year age mean")

# join
mab_compare <-
  bind_rows(mab1, mab5)

# Visual comparison
mab_compare %>% 
  ggplot(aes(x = year, y = MAB, color = country, linetype = version)) +
  geom_line() +
  labs(title = "Yes, age groups can matter for some statistics!")
```



# References