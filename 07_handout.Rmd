---
title: | 
  | \includegraphics{logotip.pdf}
  |
  | KOSTAT-UNFPA Summer Seminar on Population
  | \vspace{1.5cm} \LARGE \emph{Workshop~1.~Demography in R}
  | \vspace{0.3cm} \huge \textbf{Day 7: Demographic standardization and decomposition}\vspace{0.6cm}
  | 
fontsize: 11pt
geometry: a4paper, twoside, left=2.5cm, right=2.5cm, top=2cm, bottom=2.8cm, headsep
  = 1.35cm, footskip = 1.6cm
output:
  pdf_document:
    number_sections: yes
  html_document2: default
  html_document:
    number_sections: yes
    toc: yes
  pdf_document2: default
  header-includes:
    - \usepackage{titling}
    - \usepackage{fancyhdr}
    - \pagestyle{fancy}
    - \fancyhead[LE]{\thepage~\qquad~KOSTAT-UNFPA Summer Seminar on Population}
    - \fancyhead[RE]{Workshop~1.~Demography in R}
    - \fancyhead[LO]{{Day 7: Demographic standardization and decomposition}}
    - \fancyhead[RO]{Tim Riffe\qquad~\thepage}
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\noindent\makebox[\textwidth][c]{
  \begin{minipage}[t]{0.8\textwidth}
    \centering
    \Large{Instructor: Tim Riffe \\ \texttt{tim.riffe@ehu.eus}}
   
    \vspace{.5cm}
    \Large{Assistants: \\ Jinyeon Jo: \texttt{jyjo43043@gmail.com} \\ Rustam Tursun-Zade: \texttt{rustam.tursunzade@gmail.com}}
  \end{minipage}
}


\vspace{0.8cm}
\begin{center}
\large{4 August 2022}
\end{center}
\vspace{0.8cm}


\tableofcontents

# Summary

Today we will use tidy processing skills to age-standardize different demographic rates in order to make them more comparable. We will also explain some demographic decomposition approaches, and see how these work well using the function-writing and tidy processing skills that we've learned so far. Credit goes to [Prof. Marie-Pier Bergeron-Boucher](https://www.sdu.dk/en/forskning/forskningsenheder/samf/cpop/about_the_centre/our_people/cpop_dem/marie_pier_bergeron_boucher), for originally organizing the logic of this lesson as of 2019. I've redone the entire `R` code here, and this is now the second iteration of this material moving through me.

# Data

We will compare mortality in USA and Japan. I downloaded their mortality rates from the HMD and combined them into a single tidy dataset. I save you having to replicate that code and have posted the data as a `csv` on the github site. You can read it directly into `R`, below.

We'll be doing some decomposition exercises today, and for some methods we'll want the `DemoDecomp` package, which implements some generalized decomposition methods in a standard way. 
```{r, eval = FALSE}
install.packages("DemoDecomp")
```
I sometimes make updates to it without pushing to the main `R` repositories, so you could also get a more up to date version of the package here, if so inclined
```{r, eval = FALSE}
install.packages("remotes")
library(remotes)
install_github("timriffe/DemoDecomp")
```

Get the data and load our beloved packages:
```{r, message = FALSE}
library(tidyverse)
library(readr)
library(DemoDecomp)
# will copy this link into the google doc too
# I cut the url so it would fit on a pdf line...
raw_repo      <- "https://raw.githubusercontent.com/timriffe/KOSTAT_Workshop1"
specific_file <- "master/Data/Decomp_inputs.csv"
full_url      <- paste(raw_repo, specific_file,sep = "/")
M <- read_csv(full_url)

```

# Standardization 

Standardization is a commonly used procedure when comparing rates or probabilities for groups with differences in composition. This procedure is used to avoid the confounding effect of the population structure by simply equalizing structure for all groups.


## Problems with crude measures

Let's start by comparing the crude mortality rates in Japan and USA in 2014.


```{r message=F, warning=F}
M %>% 
  filter(Sex == "total",
         Year == 2014) %>% 
  mutate(Deaths = M * Exposure) %>% 
  group_by(Country) %>% 
  summarize(CDR = sum(Deaths) / sum(Exposure) * 1000)
```


Japan has a higher CDR than USA. On the surface it may seem as if Japan had *higher mortality* than USA. However, if we look at the age-specific death rates, we have a different story.

```{r, message = FALSE, warning = FALSE}
# Age-specific death rates
M %>% 
  filter(Sex == "total",
         Year == 2014) %>% 
  ggplot(aes(x = Age, y = M, color = Country)) + 
  geom_line() +
  scale_y_log10() +
  labs(title = "Age-specific death rates in Japan and USA, 2014",
       subtitle = "These appear higher in USA?") +
  theme_minimal()


```


Here, we see that Japan has lower age-specific death rates than USA at all ages, despite having a higher CDR. This occurs because 1) mortality has a strong age gradient: stronger than the international differences in this comparison, and 2) therefore the CDR is very sensitive to the population age structure, which is acts as weight for the CDR. 

```{r, message = FALSE, warning = FALSE}
breaks = seq(-0.01, 0.01, 0.0025)

M %>% 
  filter(Year == 2014,
         Sex != "total") %>% 
  group_by(Country) %>% 
  mutate(Structure = Exposure / sum(Exposure),
         Population = ifelse(Sex == "male", -Structure, Structure)) %>% 
  ungroup() %>% 
  ggplot(aes(x = Age, 
             y = Population, 
             color = Country, 
             group = interaction(Sex, Country))) +
  geom_step() + 
  coord_flip() +
  scale_y_continuous(breaks = seq(-0.01, 0.01, 0.0025),
                   labels = paste0(as.character(
                       c(seq(.01, 0, -.0025), seq(0.0025, 0.01, 0.0025))*100), "%")) +
  labs(title = "Population structure in Japan and USA",
       subtitle = "Japan has a higher fraction of population in older ages") +
  theme_minimal()

```

The age pyramids indicate that Japan has an older age structure than USA. In 2014, 26% of Japanese population was aged 65 years old or higher, compared with 12% in USA. As death rates are much higher at older ages than at younger age, older population will tend to have a higher CDR than younger population. 

## Direct standardization

To avoid the confounding effect of population structure (e.g. age structure) when comparing rates, direct standardization can be used. This method allows us to estimate what the crude rate *would be* if both populations had the same age structure.    

An important relation between structure-specific rates ($r_c$) and crude rates (R) is:

\begin{equation}
\label{eq:Rel}
R = \sum_c^{\infty} r_c s_c
\end{equation}

where $s_c$ is the population structure by component $c$ (for example age, or age and sex). For the crude death rates, 

$$ CDR = \frac{\sum D_x}{\sum P_x} = \sum_x^{\infty} m_x s_x $$.

where $s_x = \frac{P_x}{\sum (P_x)}$, i.e. the population structure net of its size.

The direct standardization method consists in:

* Finding a *standard* structure ($s^A_c$), e.g. an average structure between the population compared or the structure of one of these populations.
* Multiplying the component-specific rates ($r_c$) of the studied population by the standard structure.
* The standardized crude rates are found by summing $s^A_c r_c$


```{r, message = FALSE, warning = FALSE}
# calculate structure for each country
Str <-
  M %>% 
  filter(Year == 2014,
         Sex != "total") %>% 
  group_by(Country) %>% 
  mutate(Structure = Exposure / sum(Exposure)) 

# average structure (within age and sex) to get the standard
ST <- 
  Str %>% 
  group_by(Age, Sex) %>% 
  summarize(Structure = mean(Structure), 
            .groups= "drop") %>% 
  mutate(Country = "Standard")
```

Now let's combine the country-specific and mean structures into a single data object and plot them again as a pyramid so that we see what the shared structure looks like:
```{r}
# object to help with plotting breaks and labels
my_breaks <- seq(-0.01, 0.01, 0.0025)
Str %>% 
  bind_rows(ST) %>% 
  mutate(Population = ifelse(Sex == "male", -Structure, Structure)) %>% 
  ggplot(aes(x = Age, y = Population, color = Country, group = interaction(Sex, Country))) +
  geom_step() + 
  coord_flip() +
  scale_y_continuous(breaks = my_breaks,
                   labels = paste0(as.character(
                       c(seq(.01, 0, -.0025), seq(0.0025, 0.01, 0.0025))*100), "%")) +
  labs(title = "Population structure in Japan and USA",
       subtitle = "The standard") +
  theme_minimal()
```


```{r}
# Step 2: Find the standardized CDR

M %>% 
  filter(Year == 2014)

ST2 <- ST %>% 
  select(-Country, Structure, Age) %>% 
  group_by(Age) %>% 
  summarize(Standard = mean(Structure))

# Filter down to our year, join the standard to it,
# then calculate within countries
M %>% 
  filter(Year == 2014,
         Sex == "total") %>% 
  mutate(Deaths = M * Exposure) %>% 
  left_join(ST2, by= c("Age")) %>% 
  group_by(Country) %>% 
  summarize(CDR = 1000 * sum(Deaths) / sum(Exposure),
            ASDR = 1000 * sum(M * Standard))
```

After standardization, Japan has a lower CDR than USA, the CDR being now consistent with what observed at the age-specific level.

### World standards

If you need to compare multiple populations, it may be convenient to apply an international standard population structure, of which there are many. In this case, it's *usually* preferable to apply a recognized standard rather than your own (unless you have reasons to make your own), and the steps would be really similar to what we just did. Here is a decent list and source for international standards [https://seer.cancer.gov/stdpopulations/stdpopdic.html](https://seer.cancer.gov/stdpopulations/stdpopdic.html), there may of course be others. This list has standards in age groups as well as two single-age standards, as of this writing. Data are delivered in fixed width files, which we no know how to read in :-). 


```{r}
specs <-
  fwf_widths(widths = c(3,3,8),
             col_names = c("standard_code",
                              "age",
                              "pop"))
WHO_standard <-             
  read_fwf("https://seer.cancer.gov/stdpopulations/stdpop.singleagesthru99.txt",
         col_positions = specs,
         show_col_types = FALSE) %>% 
  filter(standard_code == "012") %>% 
  mutate(age = as.integer(age),
         pop = as.integer(pop),
         pop = pop / sum(pop))

```

If you have single-age data, don't limit yourself to single-age standards if you prefer one of the others: instead you can *expand* and age-grouped standard to single ages assuming uniformity within age groups. Here's a trick that may help. (`WHO_5` is a convenient aggregation of the above in order to demonstrate the trick)

```{r, include = FALSE}
WHO_5 <-
WHO_standard %>% 
  mutate(age = age - age %% 5) %>% 
  group_by(age) %>% 
  summarize(pop = sum(pop))
```

The steps imply repeating each 5-year value 5 times, then scaling down by 5 (uniform distribution within each age class). The later lines compress 0-104 into 100+.
```{r}
head(WHO_5)
WHO_5_expanded <- tibble(age = 0:104,
                         pop = rep(WHO_5$pop, each = 5) / 5) %>% 
  mutate(age = if_else(age > 100, 100L, age)) %>% 
  group_by(age) %>% 
  summarize(pop = sum(pop),
            .groups = "drop")
```


## Indirect standardization

The indirect standardization is used to estimate what would be the crude rates if both populations had the same component-specific rates. This method allows quantifying the effect of population structure on mortality.

The method consists in:

* Finding *standard* component-specific rates ($r^A_c$).
* Multiplying the population structures ($s_c$) of the studied population by the standard component-specific rates.
* The standardized crude rates are found by summing $s_c r^A_c$

```{r message=F, warning=F}

# Step 1: Find the standard age-specific rates
# We here use the average
STrates <-
  M %>% 
  filter(Year == 2014, 
         Sex == "total") %>% 
  group_by(Age) %>% 
  summarize(M_standard = mean(M))

M %>% 
  filter(Year == 2014,
         Sex == "total") %>% 
  left_join(STrates, by = "Age") %>% 
  group_by(Country) %>% 
  summarize(CDR = 1000 * sum(Exposure * M) / sum(Exposure),
            ASDRi = 1000 * sum(Exposure * M_standard) / sum(Exposure))

```

# Decomposition methods

Decomposition methods are common tools in demography, used to understand differences in a demographic measure between two or more populations. These methods allow quantifying the exact contribution of specific components, such as ages and causes of death, to this difference between populations. There are two broad families of decompositions: 

1. Decompositions that explain differences in terms of individual parameters of functions. For example, a difference in life expectancy can be broken down into contributions from differences in each age and cause of death.

2. Decompositions that re-express and explain differences phenomena in terms of abstractions of the raw parameters. For example, differences in life expectancy could be broken down into three additive components for *ontogenscence*, *young adult*, and *senescent* mortality. The catch is that these three components need to be estimated: they are not observed parameters. Many decompositions fall into this category. Some examples will be given in the session.

In this session, we only have time to cover the first sort of decompositon: We will see how to explain differences in functions of empirically observed demographic parameters, such as rates.

## Kitagawa decomposition: Decomposing differences in crude rates

Kitagawa decomposition [@kitagawa1955components] aims at quantifying how much of the difference between two crude rates is due to composition effects (e.g. difference in the age-structures) and how much is due to differences in the component-specific rates.

The Kitagawa decomposition [@kitagawa1955components] was the first to decompose the difference between two rates by a composition effect and a rate effect, using multiple standardization. It brings together both *direct* and *indirect* standardization. 

For example, when applied to the CDR (using `J` and `T` for Japan and USA), the decomposition is written as:

$$
CDR^J - CDR^T = \underbrace{\sum_x^{\infty} (m_x^J - m_x^T)\big( \frac{s_x^J + s_x^T}{2} \big)}_{RE:~rate~effect} + \underbrace{\sum_x^{\infty} (s_x^J - s_x^T)\big( \frac{m_x^J + m_x^T}{2} \big)}_{CE:~composition~effect}
$$
The left hand side of the equation (named RE) captures how much of the difference in the CDR between Japan and USA is due to difference in age-specific death rates ($m_x$). This is the same process as finding the difference between the two crude rate after direct standardization, using the average population structure as standard.

The right hand side of the equation (named CE) captures how much of the difference in the CDR is due to age-structure ($s_x$) differences. This is the same process as finding the difference between the two crude rate after indirect standardization, using the average age-specific rate as standard.

```{r, message = FALSE, warning = FALSE}
# Get data in convenient format for side-by side calcs
M_Dec <-
  M %>% 
  filter(Year == 2014, 
         Sex == "total") %>% 
  group_by(Country) %>% 
  mutate(Sx = Exposure / sum(Exposure)) %>% 
  ungroup() %>% 
  select(-Exposure) %>% 
  pivot_wider(names_from = Country, values_from = c(M, Sx))


M_Dec %>% 
  mutate(
    # calculate standards
         M_st = (M_USA + M_Japan) / 2,
         Sx_st = (Sx_USA + Sx_Japan) / 2,
    # weight differences
         RE = (M_Japan - M_USA) * Sx_st,
         CE = (Sx_Japan - Sx_USA) * M_st) %>% 
    # summarize decomp results, compare with original CDR
  summarize(RE = sum(RE) * 1000,
            CE = sum(CE) * 1000,
            CDR_Japan = sum(M_Japan * Sx_Japan) * 1000,
            CDR_USA = sum(M_USA * Sx_USA) * 1000) %>% 
  mutate(CDR_diff = CDR_Japan - CDR_USA)

```

The CDR is only one of few measures that can be decomposed with the Kitagawa method. The CBR, GFR, survival rates/probabilities, neonatal mortality rates, case fatality rates to names only a few, can also be decomposed using this method, as long as the relation between components-specific rates and the components structure, as expressed in equation (\ref{eq:Rel}), holds. The components can be age, socioeconomic status, race, etc. 

More than one structure/composition effects can also be included using a generalization of this approach. For more information see @kitagawa1955components and @gupta1978general. 

## Arriaga decomposition: Decomposing differences in life expectancy

The Arriaga method [@arriaga1984measuring] allows to decompose the difference in life expectancy by age. 

The method is based on survival probabilities ($l_x$) and person-years ($_nL_x$ and $T_x$) in the life table. We will calculate a lifetable as from Class 2. Except we need to hand-calculate `nAx`, being reasonably sensitive for age 0. There are standard rules for $a(0)$ for infant ages. What you see below in the `case_when()` is a simplification of the HMD protocol at http://www.mortality.org/Public/Docs/MethodsProtocol.pdf [@HMD, p.37] for more details. I have simplified the HMD piecewise approach by averaging male and female model results. 

```{r}
# loads lifetable from session 4!
specifc_file2  <- "master/04_lifetable_functions.R"
full_url2 <- paste(raw_repo, specifc_file2, sep = "/")
source(full_url2)


LT <- 
  M %>% 
  filter(Year == 2014, Sex == "total") %>% 
  # need to change names to those anticipated by our function!
  rename(nMx = M) %>% 
  mutate(AgeInt = 1,
         
         nAx = case_when(
                Age == 0 & nMx < .02012 ~ .14916 - 2.02536 * nMx,
                Age == 0 & nMx < .07599 ~ 0.037495 + 3.57055 * nMx,
                Age == 0 & nMx >= .07599 ~ 0.30663,
                Age == 110 ~ 1 / nMx,
                TRUE ~ AgeInt / 2)) %>% 
  group_by(Country) %>% 
  group_modify(~my_lifetable(Data = .x, radix = 1)) %>% 
  ungroup()  

```


The difference in life expectancy between Japan and USA is greater than 4 years. The Arriaga method can help figure out which ages (or age-groups) contribute to this difference.

```{r message=F, warning=F}
#step 2: find the difference in life expectancy
LT %>% 
  filter(Age == 0) %>% 
  select(Country, ex)
```

Let's select just the columns we'll need, and move them side by side, like before. Except, rather than typing `Japan` and `USA` so many times.... let's just type `j` and `u`?

```{r}
LT_arriaga <-
  LT %>% 
  mutate(Country = if_else(Country == "Japan","j","u")) %>% 
  select(Country, Age, lx, nLx, Tx) %>% 
  pivot_wider(names_from = Country, values_from = c(lx, nLx, Tx))
```


The method goes in two steps:

1) Find the direct effect.

The direct effect quantifies how much the difference in the number of years lived between age $x$ and $x+n$ contributes to the difference in life expectancy. It is the "*change in life years within a particular age group as a consequence of the mortality change in that age group*" [@arriaga1984measuring].

$$
_nD_x = \frac{l_x^U }{l_0^U} \big( \frac{_nL_x^J}{l_x^J} -\frac{_nL_x^U}{l_x^U} \big)
$$

2) Finding the indirect effect

The indirect effect (and interaction effect) is the "*number of person-years added to a given life expectancy because the mortality change, within a specific age group, will produce a change in the number of survivors at the end of the age interval*."[@arriaga1984measuring]

$$
_nI_x= \frac{T_{x+n}^J}{l_0^U} \big( \frac{l_x^U}{l_x^J} - \frac{l_{x+n}^U}{l_{x+n}^J} \big)
$$

One way to do it with the tidy approach:

```{r message=F, warning=F}
LT_arriaga <-
  LT_arriaga %>% 
  mutate(direct = lx_u * (nLx_j / lx_j - nLx_u / lx_u),
         indirect = lead(Tx_j) * 
           (lx_u / lx_j - 
              lead(lx_u) / lead(lx_j)),
         # impute 0 in the final NA
         indirect = ifelse(is.na(indirect),0,indirect))
```

The direct and indirect contributions sum to the total differences. The Arriaga formula is then written as:

$$
_n\Delta_x = \frac{l_x^U }{l_0^U} \Big( \frac{_nL_x^J}{l_x^J} -\frac{_nL_x^U}{l_x^U} \Big) + \frac{T_{x+n}^J}{l_0^U} \Big( \frac{l_x^U}{l_x^J} - \frac{l_{x+n}^U}{l_{x+n}^J} \Big)
$$


where $_n\Delta_x$ is the contribution to the difference in life expectancy at birth in age group x to x+n. The last (and open) age-interval consists only of the direct effect.

```{r message=F, warning=F}

arriaga <-
LT_arriaga  %>% 
  mutate(total = indirect + direct) %>% 
  select(Age, total)
  
# age pattern
arriaga %>% 
  ggplot(aes(x= Age, y= total)) +
  geom_col(width=1,col=gray(.2),fill=gray(.2)) + 
  labs(title = "Age-specific contributions of mortality differences\nto differences in life expectancy at birth",
       subtitle = "Arriaga method")
  
# decomposition sum
arriaga$total %>% sum()

# it's exact!
LT %>% 
  filter(Age == 0) %>% 
  pull(ex) %>% 
  diff()

```

An extension of the Arriaga method decomposing life expectancy by age AND cause of death is also available (see @preston2001demography). 

## Generalized decomposition

A generalized decomposition method is one that will work for *any* deterministic function of parameters. I compared this family of methods in a talk in December 2021. You can find the tutorial on my github: [https://github.com/timriffe/FDWG_decomp_code](https://github.com/timriffe/FDWG_decomp_code)

In that tutorial, I demonstrate the usage of three different generalized decomposition methods, including:

- [Horiuchi et al](https://link.springer.com/article/10.1353/dem.0.0033), with the `horiuchi()` function.
- [Andreev et al](https://www.demographic-research.org/volumes/vol7/14/), with the `stepwise_replacement()` function.
- [Caswell](https://www.sciencedirect.com/science/article/abs/pii/0304380089900197), with the `ltre()` function.

There is unfortunately no space to demonstrate these methods in this lecture, but you should know that they exist and can be very convenient, especially when there is no *à propos* method for the index you wish to decompose. If participants insist, then I will demonstrate this approach rather than the Arriaga method in the session


# References


