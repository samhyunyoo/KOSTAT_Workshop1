---
title: | 
  | \includegraphics{logotip.pdf}
  |
  | KOSTAT-UNFPA Summer Seminar on Population
  | \vspace{1.5cm} \LARGE \emph{Workshop~1.~Demography in R}
  | \vspace{0.3cm} \huge \textbf{Day 6: Processing and visualizing South Korean fertility microdata}\vspace{0.6cm}
  | 
fontsize: 11pt
geometry: a4paper, twoside, left=2.5cm, right=2.5cm, top=2cm, bottom=2.8cm, headsep
  = 1.35cm, footskip = 1.6cm
output:
  pdf_document:
    number_sections: yes
  html_document2: default
  html_document:
    number_sections: yes
    toc: yes
  pdf_document2: default
  header-includes:
    - \usepackage{titling}
    - \usepackage{fancyhdr}
    - \pagestyle{fancy}
    - \fancyhead[LE]{\thepage~\qquad~KOSTAT-UNFPA Summer Seminar on Population}
    - \fancyhead[RE]{Workshop~1.~Demography in R}
    - \fancyhead[LO]{{Day 6: Processing and visualizing South Korean fertility microdata}}
    - \fancyhead[RO]{Tim Riffe\qquad~\thepage}
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\noindent\makebox[\textwidth][c]{
  \begin{minipage}[t]{0.8\textwidth}
    \centering
    \Large{Instructor: Tim Riffe \\ \texttt{tim.riffe@ehu.eus}}
   
    \vspace{.5cm}
    \Large{Assistants: \\ Jinyeon Jo: \texttt{jyjo43043@gmail.com} \\ Rustam Tursun-Zade: \texttt{rustam.tursunzade@gmail.com}}
  \end{minipage}
}


\vspace{0.8cm}
\begin{center}
\large{3 August 2022}
\end{center}
\vspace{0.8cm}


\tableofcontents

# Summary
Today we will exercise concepts previously presented to read, process, and analyse births microdata delivered in *flat* files or *fixed-width* format. This means that data have no delimiters, but each column has a fixed character width. We will see that this data is easy to read in bulk, and we will spend most of the session aggregating, merging with population data, and visualizing various kinds of results.

# Fixed width microdata
KOSTAT kindly provided the birth data for the purpose of this workshop. Each observation in this data is an individual birth. These data contain 100% of registered births in Korea, and a selection of the many variables available from the original source. Typically these data are only accessible under restricted conditions after an application and evaluation. I will provide a link to a zipped folder containing the data to be used today, but these **should be deleted** when the workshop is over. If you need access to these data for research on Korean fertility, you should apply through the standard channels at KOSTAT. 

Note that data of this exact kind is openly available for a few countries around the world, including but not limited to [Spain](https://www.ine.es/dyngs/INEbase/en/operacion.htm?c=Estadistica_C&cid=1254736177007&menu=resultados&idp=1254735573002#!tabs-1254736195443) and the [United States](https://www.cdc.gov/nchs/data_access/vitalstatsonline.htm)

Note that KOSTAT kindly provided the data already in comma-separated format. I put it (back?) in fixed-width format myself. If you're curious to see how I did that, and what I did to test today's code, you can refer to the supplementary handout `06_data_prep.pdf`. You will not be able to execute the `.Rmd` file because you do not have the original `.csv` files. 

## Download the data
Download the data (`Korea_births_fwf.zip`) using the link given in the `Google Doc` for the course, and move it to the `Data` folder of the workshop project. Once there, you can unzip the file from `R` like so:

```{r}
unzip("Data/Korea_births_fwf.zip", 
      # in case this isn't the first time
      overwrite = TRUE,
      exdir = "Data")
```
A new folder will be created: `Data/Korea_births_fwf`, which contains one file each for years 2000-2020. Files follow the naming convention `kbyyyy.txt`, where `yyyy` is the given year. You can open one of these in a text editor and have a look. For some columns, in some places it seems obvious what a variable is, but in general we see that some sort of parsing is needed in order to get this data into any program.

Here is a glimpse of the first several rows of the first fixed-width file:
\begin{verbatim}
2000   2000   1   1      12000   1 36   34   35 2.36  
2000   2000   1   1      12000   1 27   27   37 2.4   
2000   2000   1   1      12000   1 25   25   37 2.9   
2000   2000   1   1      12000   1 29   26   38 3.49  
2000   2000   1   1      12000   1 31   24   39 3.16  
2000   2000   1   1      12000   1 35   29   39 3.24  
2000   2000   1   1      12000   1 29   28   40 3.05  
2000   2000   1   1      12000   1 34   27   40 3.3  
\end{verbatim}



## Read the data into `R`

The `readr` package has a nice function `read_fwf()` to read in this sort of data. It requires you to either know the the starting position and width of each column (in terms of characters), or the starting and stopping positions. If all you know are the widths of each column, then you must know these for each column in the data. When we read the data in, white space is automatically eliminated, and `R` guesses the data type for each column (which we can of course override if we want). Look at the help file to `?read_fwf` for examples of all the different ways to read in fixed-width data.

### Create metadata
In this case, you can read in the metadata directly from a `.csv` file in github like so:
```{r, message = FALSE}
library(tidyverse)
library(readr)
# cutting url in two pieces because it's so long it won't fit on a page!
url_base <- "https://raw.githubusercontent.com/timriffe/KOSTAT_Workshop1/"
url_end  <- "master/Data/Korea_births_fwf_metadata.csv"
my_url   <- paste0(url_base, url_end)
widths <- read_csv(my_url,
                   # suppress messages
                   show_col_types = FALSE)
widths
```
From this we see we have 11 columns, and we know the width of each. To use `read_fwf()`, we just need to convert this into some standard specifications, like so:

```{r}
specs <-
  fwf_widths(widths = widths$width,
             col_names = widths$colname)
specs
```
This translation from widths should be pretty straightforward. Sometimes your metadata is already delivered just like this, with start and stop positions, ideally in a spreadsheet, but sometimes unfortunately in a `.pdf`. Even so, it's good to create this `R` object using one of the helper functions listed when you type `?fwf_widths` to ensure that it follows the stanards anticipated.

### Trial for one file
```{r}
data_in <- read_fwf("Data/Korea_births_fwf/kb2000.txt",
                    col_positions = specs)
data_in
```

### Read and merge all files using `vroom`

Install the `vroom` package from CRAN, and be sure to comment out the installation line with `#`
```{r, eval = FALSE}
install.packages("vroom")
```

To read in the file, use `vroom_fwf()`, and feed our `specs` object to the `col_positions` argument. Here I explicitly state what the data type should be for each column using a shorthand: `i` stands for integer, and `d` stands for double (data with decimals). If you omit this step, then `Birth weight` will be interpreted as character. That's not really a problem, you could coerce it back to double using `mutate(`Birth weight` = as.double(`Birth weight`))`.
```{r}
library(vroom)
rm(data_in) # remove earlier test file from memory
# a vector of file paths:
kb_folder <- "Data/Korea_births_fwf"
files <- file.path(kb_folder,
                   dir(kb_folder))

# read and merge, very fast :-)
KB     <- vroom_fwf(files,
                    col_positions = specs,
                    col_types = "iiiiiiidddd")
str(KB)
```

It appears there were 9369102 births registered in South Korea between the years 2000 and 2020, inclusive.

## tidy the data some

First, the names are a bit awkward to type out in back-tics whenever we want to refer to a variable in code. I'd prefer to type `mother_detailed_age` rather than `r '\x60(Mother) detailed age\x60'`

```{r}
library(janitor)
KB <-
  KB %>% 
  clean_names()
```



```{r}
KB %>% pull(month_of_birth) %>% table()
KB %>% pull(year_of_birth) %>% table()
# code 999 is unstated age
KB %>% pull(father_detailed_age) %>% floor() %>% table()
KB %>% pull(mother_detailed_age) %>% floor() %>% table()
```

