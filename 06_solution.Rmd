---
title: "session 6 exercise solution"
author: "Tim Riffe"
date: "2022-08-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Big Exercise

We ended with an ambitious exercise to work through at the start of the next session. I believe it will consist in a somewhat novel question

1. Look in the git repo for a file called `Korea_exposures.csv` in the `Data` folder. Read it in directly from the web using `read_csv()`.

2. Tabulate the births data by single ages. Note that some ages have decimals, you can round them down using floor() before tabulating.

3. Note that 999 is the missing code for ages.
4. Redistribute missing ages in each year for men and women.
5. Join the join the mothers’ file and fathers’ file (births) into a single file that can be joined with the exposures. To do this right before joining you’ll rename `mo_age` to `age` and `fa_age` to `age`, and you'll need to create a `sex` variable, with value `"f"` in the women file and `"m"` for the men file. This is for the sake of an easy join with the exposure data. You may with to complete the age range with 0s to pad any missing ages, using the `complete()` function as in the handout.
6. Then calculate male and female fertility rates
7. Calculate `TFR` and `MAB` for men and women in each year
8. Calculate `TFRadj` (see Friday solution) for men and women in each year.
9. Tell me how similar / parallel / convergent / divergent the male and female trends in `TFR` and `TFRadj` are.

## microdata pre-processing code, condensed.

```{r, message = FALSE}
library(tidyverse)
library(janitor)
library(vroom)
```


```{r}
metadata <- read_csv("https://raw.githubusercontent.com/timriffe/KOSTAT_Workshop1/master/Data/Korea_births_fwf_metadata.csv", show_col_types = FALSE)

specs <- fwf_widths(widths = metadata$width,
                    col_names = metadata$colname)
kb_files <-
  file.path("Data",
            "Korea_births_fwf",
            dir("Data/Korea_births_fwf"))
kb_files
KB <- vroom_fwf(kb_files,
                col_positions = specs,
                col_types = "iiiiiiidddd") %>% 
      clean_names() %>% 
      select(-year) %>% 
      select(year = year_of_birth,
             month = month_of_birth,
             fa_age = father_detailed_age,
             mo_age = mother_detailed_age,
             sex,
             p_weeks = no_of_weeks_of_pregnancy,
             kg = birth_weight) %>% 
      mutate(date = paste(year, month, 1) %>% ymd())


```

# The double tabulation and join

```{r}

Bf <-
  KB %>% 
  mutate(age = floor(mo_age)) %>% 
  group_by(year, age) %>% 
  summarize(births = n(),
            .groups = "drop") %>% 
  group_by(year) %>% 
  mutate(unk = births[age == 999]) %>% 
  filter(age != 999) %>% 
  mutate(births = births + births / sum(births) * unk) %>% 
  ungroup() %>% 
  complete(age = (10:70), 
           year, 
           fill = list(births = 0)) %>% 
  mutate(sex = "f") %>% 
  select(-unk)

Bm <-
  KB %>% 
  mutate(age = floor(fa_age)) %>% 
  group_by(year, age) %>% 
  summarize(births = n(),
            .groups = "drop") %>% 
  group_by(year) %>% 
  mutate(unk = births[age == 999]) %>% 
  filter(age != 999) %>% 
  mutate(births = births + births / sum(births) * unk) %>% 
  ungroup() %>% 
  complete(age = (10:80), year, fill = list(births = 0)) %>% 
  mutate(sex = "m") %>% 
  select(-unk)

B <- bind_rows(Bf, Bm)

E <- read_csv("https://raw.githubusercontent.com/timriffe/KOSTAT_Workshop1/master/Data/Korea_exposures.csv", show_col_types = FALSE) %>% 
  mutate(age = as.integer(age),
         expos = expos * 1000)

# note if the age-coersion to integer or numeric or double is missing, 
# then the join fails!
D <- left_join(B, E, by = c("sex","year","age"))
```

## Visualize ASFR

```{r, warning = FALSE, fig.width = 12, fig.height = 8}
D %>% 
  mutate(asfr = births / expos) %>% 
  ggplot(mapping = aes(x = age, 
                       y = asfr, 
                       alpha = year, 
                       group = year))+
  geom_line() +
  facet_wrap(~sex) +
  xlim(13,60)
```

## Get summary indices

```{r}
indices <-
  D %>% 
  mutate(asfr = births / expos) %>% 
  group_by(sex, year) %>% 
  summarize(TFR = sum(asfr),
            MAB = sum((age + 0.5) * asfr) / sum(asfr),
            .groups = "drop") %>% 
  group_by(sex) %>% 
  mutate(rt = (lead(MAB) - lag(MAB)) / 2,
         TFRadj = TFR / (1 - rt)) %>% 
  ungroup()
```

Plot them:

mean age at childbearing:

```{r, warning = FALSE}
indices %>% 
  ggplot(mapping = aes(x = year, y = MAB, color = sex)) +
  geom_line()
```

TFR indices:
```{r, warning = FALSE, fig.width = 12, fig.height = 8}
indices %>% 
  select(-MAB) %>% 
  pivot_longer(c(TFR, TFRadj),
               names_to = "variant",
               values_to = "TFR") %>% 
  ggplot(mapping = aes(x = year, 
                       y = TFR, 
                       color = sex, 
                       linetype = variant, 
                       group = interaction(sex,variant))) +
  geom_line() +
  labs(title = "Tim concludes these lines are essentially parallel",
       subtitle = "That is not to say we don't have a story")
```

