---
title: "Session 6 notes"
author: "Tim Riffe"
date: "2022-08-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## package installation

```{r, eval = FALSE}
install.packages("janitor")
install.packages("lubridate")
install.packages("ggridges")
install.packages("vroom")
install.packages("countrycode")
install.packages("remotes")
remotes::install_github("PPgp/wpp2022")
```

```{r, message = FALSE}
library(tidyverse)
library(lubridate)
library(ggridges)
library(vroom)
library(countrycode)
library(wpp2022)
library(janitor)
```

## Get metadata
Read in the metadata on column positions and transform it into a column metadata format recognized by `read_fwf()`.
```{r}
metadata <- read_csv("https://raw.githubusercontent.com/timriffe/KOSTAT_Workshop1/master/Data/Korea_births_fwf_metadata.csv", show_col_types = FALSE)

specs <- fwf_widths(widths = metadata$width,
                    col_names = metadata$colname)
specs
```

## unzip the file

`exdir` is where we should put the unzipped contents
```{r}
unzip("Data/Korea_births_fwf.zip",
      exdir = "Data")
```

## read in all the data

```{r}
kb_files <-
  file.path("Data",
            "Korea_births_fwf",
            dir("Data/Korea_births_fwf"))

KB <- vroom_fwf(kb_files,
                col_positions = specs,
                col_types = "iiiiiiidddd")

# used this to count out the column types:
KB %>% colnames()
# to check the object size in memory 
KB %>% object.size() %>% print(units = "Mb")
```

## clean the names
```{r}
KB <- 
  KB %>% 
  clean_names() %>% 
  select(-year) %>% 
  select(year = year_of_birth,
         month = month_of_birth,
         fa_age = father_detailed_age,
         mo_age = mother_detailed_age,
         sex,
         p_weeks = no_of_weeks_of_pregnancy,
         kg = birth_weight)
```

## create a helper column for dates

```{r}
ymd("2000 1 1")
paste("2000" , 1, "01") %>% ymd()

KB <-
  KB %>% 
  mutate(date = paste(year, month, 1) %>% ymd())
KB
```

## What is the trend and seasonality of births

```{r}
KBmonths <-
  KB %>% 
  group_by(date) %>% 
  summarize(births = n()) 
KBmonths %>% 
  ggplot(mapping = aes(x = date, y = births)) +
  geom_line() +
  geom_point(data = KBmonths %>% filter(month(date) == 1),
             mapping = aes(x = date, y = births),
             color = "red") +
  geom_point(data = KBmonths %>% filter(month(date) == 12),
             mapping = aes(x = date, y = births),
             color = "blue")
```

## Exercise 1 (8 minutes)

Make a time series graph of average and median birth weight.
`mean()`, `median()`
`pivot_longer()`
*map `color` or `linetype` to the centrality measure.

Tell me if birth weight is seasonal and shout out a hypothesis as to why or why not.

```{r}
KB %>% 
  group_by(date) %>% 
  summarize(kg_median = median(kg),
            kg_mean = mean(kg)) %>% 
  pivot_longer(c(kg_median, kg_mean),
               names_to = "variant",
               values_to = "kg") %>% 
  ggplot(mapping = aes(x = date,
                       y = kg,
                       color = variant)) +
    geom_line()
```

General way to make a density
```{r, eval = FALSE}
KB %>% 
  ggplot(aes(x = kg)) +
  geom_density()
```

Question: how much does this distribution vary by mother or father age? Target graphical form: `ridgeplot()`

```{r}
KB_kg_ridge_data <- 
  KB %>% 
  filter(mo_age != 999,
         kg > 0) %>% 
  mutate(mo_age = mo_age - mo_age %% 5,
         kg = round(kg, 1)) %>% 
  group_by(mo_age, kg) %>% 
  summarize(births = n(),
            .groups = "drop") %>% 
  group_by(mo_age) %>% 
  mutate(dens = births / sum(births))
  
KB_kg_ridge_data %>% 
  filter(mo_age < 60) %>% 
  ggplot(aes(x = kg, 
             y = factor(mo_age),
             height = dens)) +
  geom_ridgeline(scale = 15, alpha = .5)
```

## Question: 
Is the above age pattern of the distribution of birth weight different or identical for boys and girls?

```{r}
KB_kg_ridge_data_sex <- 
  # remove unk ages of mothers
  KB %>% 
  filter(mo_age != 999,
         # remove mystery 0 weight at birth
         kg > 0) %>% 
  # create intervals to aggregate within,
  # recode, etc
  mutate(mo_age = mo_age - mo_age %% 5,
         kg = round(kg, 1),
         sex = if_else(sex == 1, "boy","girl")) %>% 
  # perform tabulation of cases
  group_by(mo_age, kg, sex) %>% 
  summarize(births = n(),
            .groups = "drop") %>% 
  # calculate densities
  group_by(mo_age, sex) %>% 
  mutate(dens = births / sum(births)) %>% 
  ungroup()
  
KB_kg_ridge_data_sex %>% 
  filter(mo_age < 60) %>% 
  ggplot(aes(x = kg, 
             y = factor(mo_age), # the baseline of the ridgeplot
             height = dens,
             fill = sex)) +
  geom_ridgeline(scale = 15, alpha = .5)
```

## Process exposure data

```{r}
library(readxl)

col_types <- c(rep("text",10),rep("numeric",102))
Ef <- suppressWarnings(read_excel("Data/WPP2022_POP_F01_3_POPULATION_SINGLE_AGE_FEMALE.xlsx", 
                skip = 16, 
                n_max = 10000,
                col_types = col_types)) %>% 
  filter(`Location code` == 410) %>% 
  pivot_longer(`0`:`100+`,
               names_to = "age",
               values_to = "expos") %>% 
  select(year = Year,
         age, 
         expos,
         sex = "")



```



