---
title: | 
  | \includegraphics{logotip.pdf}
  |
  | KOSTAT-UNFPA Summer Seminar on Population
  | \vspace{1.5cm} \LARGE \emph{Workshop~1.~Demography in R}
  | \vspace{0.3cm} \huge \textbf{Day 8: Data prep for Advanced processing and visualization}\vspace{0.6cm}
  | 
fontsize: 11pt
geometry: a4paper, twoside, left=2.5cm, right=2.5cm, top=2cm, bottom=2.8cm, headsep
  = 1.35cm, footskip = 1.6cm
output:
  pdf_document:
    number_sections: yes
  html_document2: default
  html_document:
    number_sections: yes
    toc: yes
  pdf_document2: default
  header-includes:
    - \usepackage{titling}
    - \usepackage{fancyhdr}
    - \pagestyle{fancy}
    - \fancyhead[LE]{\thepage~\qquad~KOSTAT-UNFPA Summer Seminar on Population}
    - \fancyhead[RE]{Workshop~1.~Demography in R}
    - \fancyhead[LO]{{Day 8: Data Prep for Advanced processing and visualization}}
    - \fancyhead[RO]{Tim Riffe\qquad~\thepage}
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\noindent\makebox[\textwidth][c]{
  \begin{minipage}[t]{0.8\textwidth}
    \centering
    \Large{Instructor: Tim Riffe \\ \texttt{tim.riffe@ehu.eus}}
   
    \vspace{.5cm}
    \Large{Assistants: \\ Jinyeon Jo: \texttt{jyjo43043@gmail.com} \\ Rustam Tursun-Zade: \texttt{rustam.tursunzade@gmail.com}}
  \end{minipage}
}


\vspace{0.8cm}
\begin{center}
\large{5 August 2022}
\end{center}
\vspace{0.8cm}


\tableofcontents


# Summary
The two most-voted items on the Friday data list were GBD and WPP2022. So, I've decided to get prevalence of different illnesses from GBD and combine them with WPP lifetables to calculate healthy life expectancy using the Sullivan method (@sullivan1971single). We can do the WPP data part entirely in session.

I went to this download center for GBD @gbd2019: [https://vizhub.healthdata.org/gbd-results/](https://vizhub.healthdata.org/gbd-results/) and selected all countries and territories, abridged ages, *prevalence* of each available *impairment*, all available years (1990-2019), and males and females. The tool requires registration (free and fast). On making the selection, a link is generated where the downloads are prepared. Downloads are split into chunks of 500000 rows. There were 60 of them, zipped csv files. 

# Read-filter-save function

This lightly processes the zipped downloads and resaves them as g-zipped csv files.
```{r, eval = FALSE}
library(tidyverse)

base_path <-"Data/GBD-downloads/IHME-GBD_2019_DATA-a6292c91-"
for (i in 1:60){
  this_path <- paste0(base_path,i,".zip")
  path_out <- paste0("Data/GBD/","gbd-",i,".csv.gz")
  read_csv(this_path,
           show_col_types = FALSE) %>% 
    filter(metric == "Percent") %>% 
    select(location, sex, age, year, prev = val) %>% 
    write_csv(path_out)
}
```

## bind together w vroom

This reads all of the g-zipped data files, merges them together (in one step w `vroom`), and recodes `age` using a join method (I made a look-up table).
```{r, eval = FALSE}
gbd_folder <- "Data/GBD"
gbd <- vroom::vroom(file.path(gbd_folder,dir(gbd_folder)),
                    show_col_types = FALSE)
gbd_ages <- read_csv("Data/gbd_ages.csv",
                     show_col_types = FALSE)
gbd %>% 
  filter(age != "All ages") %>% 
  rename(age_label = age) %>% 
  left_join(gbd_ages, by = "age_label") %>% 
  select(-age_label) %>% 
  write_csv("Data/GBD/gbd_share.csv.gz")
```

We can work directly with this merged file to select what we want to produce healthy life expectancy estimates using different variables. We'll use UN lifetables for this.

# References