---
title: "Session 8 notes"
author: "Tim Riffe"
date: "2022-08-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary

```{r, message = FALSE}
library(tidyverse)
library(vroom)
library(janitor)
library(countrycode)
```


# Read in WPP 2022 abridged lifetables

```{r}
wpp <- read_csv("Data/wpplt.zip",
                show_col_types = FALSE)
wpp <-
  wpp %>% 
  mutate(location = countrycode(LocID,
                                origin = "un",
                                destination = "country.name.en",
                                warn = FALSE)) %>% 
  filter(!is.na(location)) %>% 
  select(iso3 = ISO3_code,
         sex = Sex,
         year = Time,
         age = AgeGrpStart,
         mx, Lx, ex) %>% 
  mutate(Lx = Lx / 100000)

```


# Read in GBD

```{r}
gbd <- read_csv("Data/gbd_share.csv.gz",
                show_col_types = FALSE)

gbd <-
  gbd %>% 
  mutate(iso3 = countrycode(location,
                            origin = "country.name.en",
                            destination = "iso3c")) %>% 
  arrange(location, measure, sex, year, age)

object.size(gbd) %>% print(units = "Mb")
```

## What measures do we have?

```{r}
gbd %>% pull(measure) %>% unique()
```

## Check sums
 
Is Anemia equal to the sum of mild and severe anemia? Let's do a check and see how this works so that we can do more intelligent calculations later

```{r}
gbd %>% 
  filter(iso3 == "AFG",
         year == 2019,
         sex == "Female",
         measure %in% c("Anemia", "Mild anemia", "Moderate anemia", "Severe anemia")) %>% 
  pivot_wider(names_from = measure, values_from = prev) %>% 
  mutate(check_sum = `Mild anemia` + `Moderate anemia` + `Severe anemia`) %>% 
  select(age, Anemia, check_sum)
```

Yes, the basic illness indicators are the sum of the severity breakdowns.

## examine some subsets
```{r, fig.width = 10, fig.height = 7}
gbd %>% 
  filter(iso3 %in% c("AUS","KOR","PER"),
         measure %in% c("Severe anemia", "Severe vision loss")) %>% 
  ggplot(mapping = aes(x = age,
                       y = prev,
                       color = sex,
                       alpha = year, 
                       group = interaction(year, sex))) +
  geom_line() +
  # new! gridded facetting, note prev measures are in rows
  # and locations in columns
  facet_grid(vars(measure), 
             vars(location)) +
  labs(y = "Anemia prevalence") +
  theme_minimal()
```


## Test merge



```{r}
wpp_test <- wpp %>% 
  filter(iso3 == "KOR")

gbd_test <- gbd %>% 
  filter(iso3 == "KOR")

# success
left_join(gbd_test,
          wpp_test,
          by = c("iso3","sex","year","age"))
```

## a little bit of lifetable rigor

Note, the lifetables close out at 100+, but the prevalence closes out at 95+, so we should do a little bit of adjustment to the lifetables to make these match.
```{r}
wpp <-
  wpp %>% 
  mutate(age = ifelse(age > 95, 95, age)) %>% 
  group_by(iso3, sex, year, age) %>% 
  summarize(mx = mx[1],
            Lx = sum(Lx),
            ex = ex[1],
            .groups = "drop")
```


```{r}

# wpp <-
#   wpp %>% 
#   rename(ex = `ex[1]`)
wpp_test <-
  wpp %>% 
  filter(year == 2000,
         sex == "Female",
         iso3 == "KOR")

gbd_test <-
  gbd %>% 
  filter(year == 2000,
         sex == "Female",
         iso3 == "KOR",
         measure == "Severe anemia")
join_test <- 
left_join(gbd_test, 
          wpp_test, 
          by = c("iso3", "sex", "year", "age"))
```

## demonstrate Sullivan

```{r}
join_test %>% 
  ggplot(mapping = aes(x = age,
                       y = Lx / c(1,4,rep(5,19)))) +
  geom_step() +
  ylim(0,1) +
  geom_step(mapping = aes(x = age, 
                          y = prev),
            color = "red") +
  geom_step(mapping = aes(x = age,
                          y = Lx / c(1,4,rep(5,19)) * prev),
            color = "orange")
```

```{r}
join_test %>% 
  summarize(Anemia_LE = sum(Lx * prev),
            Anemia_free_LE = ex[age == 0] - Anemia_LE,
            LE = ex[age == 0])
```

## Hearing loss

```{r}
countrycode("Somalia", origin = "country.name.en", destination = "iso3c")

codes <- c("ESP","USA","DEU","KOR","BGD","SOM")
measures <- c("Hearing loss","Complete hearing loss","Mild hearing loss","Moderate hearing loss","Severe hearing loss")

# all(measures %in% gbd$measure)

hearing <-
gbd %>% 
  filter(year == 2019,
         iso3 %in% codes,
         measure %in% measures) %>% 
  left_join(wpp, by = c("iso3","year","sex","age")) %>% 
  group_by(iso3, sex, measure) %>% 
  summarize(hearing_loss_LE = sum(prev * Lx),
            better_hearing_LE = sum((1 - prev) * Lx),
            LE = sum(Lx),
            .groups = "drop")
```

## visualize

```{r}


hearing %>% 
  ggplot(mapping = aes(x = hearing_loss_LE, 
                       y = fct_reorder(iso3, hearing_loss_LE),
                       color = sex)) +
  facet_wrap(~measure, scales = "free_x") +
  geom_point()


```

















