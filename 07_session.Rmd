---
title: "day 7 notes"
author: "Tim Riffe"
date: "2022-08-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Standardization

Standardization is one way to make comparable summary indices of age-specific rates.


## Read in toy data
```{r, fig.height = 8, fig.width = 10}
library(tidyverse)
url <- "https://raw.githubusercontent.com/timriffe/KOSTAT_Workshop1/master/Data/Decomp_inputs.csv"

M <- read_csv(url, show_col_types = FALSE) 

M %>% 
  filter(Year == 2014,
         Sex != "total") %>% 
  ggplot(mapping = aes(x = Age, y = M, 
                       color = Country)) +
  geom_line() +
  scale_y_log10() +
  facet_wrap(~Sex) +
  labs(title = "USA has higher rates in every age")
```

```{r}
M
M %>% 
  filter(Year == 2014,
         Sex == "total") %>% 
  group_by(Country) %>% 
  summarize(CDR = sum(M * Exposure) / sum(Exposure) * 1000)
```
# Direct standardization

Calculate an age structure that's half way between the two populations.
```{r}
Ready_to_standardize <-
M %>% 
  filter(Year == 2014,
         Sex == "total") %>% 
  group_by(Country) %>% 
  mutate(Structure = Exposure / sum(Exposure)) %>% 
  group_by(Age) %>% 
  mutate(Standard = mean(Structure)) 
Ready_to_standardize %>% 
  group_by(Country) %>% 
  summarize(CDR = sum(M * Structure) * 1000,
            DSDR = sum(M * Standard) * 1000)
  # summarize(CDR_E = sum(M * Exposure) / sum(Exposure) * 1000,
  #           CDR_S = sum(M * Structure) * 1000)
```

```{r}
Ready_to_standardize %>% 
  ggplot(mapping = aes(x = Age, y = Structure, color = Country)) +
  geom_step() +
  geom_step(mapping = aes(x = Age, y = Standard),
            color = "black", size = 2)
```

## an aside, but which is worth our time

One could also use $1/e(0)$ as the age-standardized death rate.

```{r}
source("https://raw.githubusercontent.com/timriffe/KOSTAT_Workshop1/master/04_lifetable_functions.R")
LT <-
  M %>% 
  filter(Year == 2014,
         Sex == "total") %>% 
  mutate(AgeInt = 1,
         nAx = if_else(Age == 0, .1, .5)) %>% 
  rename(nMx = M) %>% 
  group_by(Country) %>% 
  group_modify(~my_lifetable(Data = .x, radix = 1)) %>% 
  ungroup()

LT %>% 
  filter(Age == 0) %>% 
  select(Country, ex) %>% 
  mutate(LTSDR = 1 / ex * 1000)
# Japan	83.72342	11.94409		
# USA	78.94269	12.66742	
LT %>% 
  group_by(Country) %>% 
  summarize(LTSDR = sum(nMx * nLx) / sum(nLx) * 1000)

# Japan	11.94183			
# USA	12.66672	
```

## Indirect

An indirect decomposition does the opposite: We average the rates and weight them with the respective population structures. Then the difference in ISDR is entirely due to structure. BUT ISDR + DSDR is not equal to the different in CDR.

## Decomposition

### Kitagawa decomposition

Rate component is the difference in rates times the average structure.
Structure component is the difference in structure times the average rates.
AND these two components sum to the observed difference in crude rates.
```{r}
M %>% 
  filter(Year == 2014,
         Sex == "total") %>% 
  mutate(Country = if_else(Country == "Japan", "j", "u")) %>% 
  group_by(Country) %>% 
  mutate(st = Exposure / sum(Exposure)) %>% 
  select(-Exposure) %>% 
  pivot_wider(names_from = Country,
              values_from = c(M, st)) %>% 
  summarize(CDRj = sum(st_j * M_j)* 1000,
            CDRu = sum(st_u * M_u)* 1000,
            RE = sum((M_j - M_u) * (st_j + st_u) / 2)* 1000,
            SE = sum((st_j - st_u) * (M_j + M_u) / 2)* 1000) %>% 
  mutate(CDR_diff = CDRj - CDRu,
         Kit_diff = RE + SE)
```

## Arriaga Decompositoon, by popular vote
(the majority of which abstained)

```{r}
LT %>% 
  filter(Age == 0) %>% 
  select(Country, ex)
```

```{r}
LT %>% 
  mutate(Country = if_else(Country == "USA", "u", "j")) %>% 
  select(Country, Age, lx, Lx = nLx, Tx) %>% 
  pivot_wider(names_from = Country,
              values_from = c(lx, Lx, Tx)) %>% 
  mutate(direct = lx_u * (Lx_j/lx_j - Lx_u/lx_u),
         indirect = lead(Tx_j)*(lx_u/lx_j - lead(lx_u) / lead(lx_j)),
         indirect = if_else(is.na(indirect),0,indirect),
         contribution = direct + indirect) %>% 
  ggplot(mapping = aes(
    x = Age,
    y = contribution
  )) +
  geom_step() +
  geom_hline(yintercept = 0) +
  labs(title = "exact Arriaga decomposition of life expectancy")
```

# the generalized solution
```{r}

library(DemoDecomp)

my_ex <- function(mx){
  tibble(nMx = mx, 
         nAx = c(.1, rep(.5, 110)),
         AgeInt = rep(1, 111)) %>% 
    my_lifetable() %>% 
    slice(1) %>% 
    pull(ex)
}

Dat <-
  LT %>% 
  ungroup() %>% 
  select(Country, Age, nMx) %>% 
  pivot_wider(names_from = Country,
              values_from = nMx)
contribution <- 
 horiuchi(my_ex, 
          pars1 = Dat$Japan, 
          pars2 = Dat$USA, 
          N = 5)
  tibble(Age = 0:110, contribution) %>% 
    ggplot(mapping = aes(x = Age,
               y = -contribution)) +
    geom_step()

  -sum(contribution)

```

For a fuller comparison of Arriaga vs generalized decomp, see here:
[https://github.com/timriffe/FDWG_decomp_code](https://github.com/timriffe/FDWG_decomp_code)






